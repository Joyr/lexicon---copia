<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>{{title}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/main.css" rel="stylesheet" type="text/css"/>  
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
    
    <!--   - tagThat's base CSS (tagThat.css). -->
    <link href="css/tagThat.css" rel="stylesheet" type="text/css">
    <link rel="icon" type="image/png" href="http://lexicon.on-lingua.org/favicon.png" />
    
    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    
    <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
    
    <!-- Other plug-ins & useful tools -->
    <script src="js/util.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/constants.js"></script>
    <script src="js/tagThat.js"></script>
    <script src="js/project.js"></script>
    <script src="js/card.js"></script>
    <script src="js/gallery.js"></script>
    
    <!--EXPIRE-->
    
<!-- Other options 

-->      
</head>
<body>
<!-- Card manager Page -->
<div data-role="page" id="card-manager">
	<div data-role="header">
    	<a href="/" id="back_main" data-role="button" data-icon="back" data-ajax="false">__Back__</a>   
        <div id="lang"><select name="options-lang" id="options-lang" data-native-menu="false" data-theme="c" class="ui-btn-left" data-mini="true" data-iconpos="left">                        
            <option>__Language__</option>
            <!-- Language -->
        </select></div>   	
     	<h1>LEXICON: __Card_Manager__</h1>
        <a href="php/logout.php" class="ui-btn-right" data-ajax="false" data-theme="r" data-role="button" data-icon="delete" title="Logout" data-iconpos="right">__Logout__</a>                     	            	
    </div>
    <div data-role="content">
    	<ul data-role="listview" id="flashcards" data-theme="c" >        
            <li data-role="list-divider" id="flashcard-divider"><h1>__Project__:{{title}}</h1><span class="ui-li-count numFlashcards">0</span></li>
        </ul>	
    </div>
    <div data-role="footer" data-position="fixed">
    	<div data-role="navbar" data-iconpos="top">
        <ul>
            <li>
                <a href="#add-card-dialog" id='add-fc-btn' data-transition="slideup" data-icon="plus" data-rel="dialog">
                    __Create_Flashcard__
                </a>
            </li>
            <li>
                <a href="#card-importer" data-transition="fade" data-theme="" data-icon="arrow-d">
                    __Import__ __Flashcards__
                </a>
            </li>
            <li>
                <a href="" data-transition="fade" data-theme="" data-icon="gear" class="ui-disabled">
                    __Options__
                </a>
            </li>
        </ul>   
    	</div> 
	</div>
</div>

<!-- Cards Importer with CSV files -->
<div data-role="page" id="card-importer">
	<div data-role="header">
    	<a id="back_main" data-role="button" data-icon="back" data-transition="flip" data-rel="back">__Back__</a>      	
     	<h1>LEXICON: __Import__ __Flashcards__</h1>
        <a href="php/logout.php" class="ui-btn-right" data-ajax="false" data-theme="r" data-role="button" data-icon="delete" title="Logout" data-iconpos="right">__Logout__</a>                     	            	
    </div>
    <div data-role="content">
    	<form id="import-csv">
	        <input type="file" id="file" accept="application/msexcel" name="file"/>	          	        
	    </form>
    	<ul data-role="listview" id="card-manager-list" data-theme="c" data-inset="true">        
	        <li data-role="list-divider" id="card-manager-list-divider"><h1>__Flashcards__</h1><span id="numFlashcards-preview" class="ui-li-count">0</span></li>    
        </ul>
	</div>
    <div id="add-import-csv" data-role="footer" data-position="fixed">
    	<div data-role="navbar" data-iconpos="top">
        <ul>
            <li>
                <a data-role="button" data-icon="plus" data-rel="back">
                   __Add__
                </a>
            </li>            
        </ul> 
        </div>
    </div>
    <div data-role="popup" id="remove-flashcard-popUp" data-overlay-theme="a" data-theme="c" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
        <div data-role="header" data-theme="a" class="ui-corner-top">
            <h1>__Delete__</h1>
        </div>
        <div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">            
            <p>__MSG_delete__</p>
            <a href="#" data-role="button" data-inline="true" data-rel="back" data-theme="c">__Cancel__</a>
            <a href="#" id="delete" data-role="button" data-inline="true" data-rel="back" data-transition="flow" data-theme="r">__Delete__</a>
        </div>
	</div>
</div>

<!-- Dialogs -->

<div id="add-card-dialog" data-role="dialog">
    <div data-role="header" data-position="fixed" data-theme="a">
        <h2>__Create_Flashcard__</h2>
    </div>
    <div data-role="content" data-theme="c">                 
        	<ul data-role="listview" data-inset="true">           
	           <li>
                	__Add_an_image__ 
                    <input type="file" id="add-card-new-image" accept="image/jpeg,image/png,image/gif,image/bmp"  />
                </li>
    			<li class="question">                
                	__Question__ (*): 
                    <textarea id="add-card-question" name="question"></textarea>
                </li>
                <li class="answer">
                	__Answer__ (*):
               		<textarea id="add-card-answer" name="answer"></textarea>
                </li>
            </ul>
            <a id="add-card-btn" class="flashcard-submit" data-role="button" data-theme="b" data-icon="plus">__Create_Flashcard__</a>            
    </div>
</div>

<div id="edit-card-dialog" data-role="dialog">
    <div data-role="header" data-position="fixed" data-theme="a">
        <h2>__Edit_Flashcard__</h2>
    </div>
    <div data-role="content" data-theme="c">        
        	<ul data-role="listview" data-inset="true">         
            	<li id="edit-card-image-field">
                    <div id="edit-card-if-image">
                        <img id="edit-card-image-preview" class="flashcard-image" />
                        <a href="#card-manager" id="edit-card-image-clear" data-role="button" data-theme="e" data-icon="delete">__Remove_image__</a>
                    </div>
                    
                    <div id="edit-card-image-container">
                        <label for="edit-card-new-image">__Add_change_image__</label>
                        <input type="file" id="edit-card-new-image" accept="image/jpeg,image/png,image/gif,image/bmp"  />
                    </div>
            	</li>                      
    			<li class="question">                
                	__Question__ (*): 
                    <textarea id="edit-card-question" name="question"></textarea>
                </li>
                <li class="answer">
                	__Answer__ (*):
               		<textarea id="edit-card-answer" name="answer"></textarea>
                </li>
            </ul>                                  
            <a id="edit-card-finish" class="flashcard-submit" data-role="button" data-theme="b" data-icon="check">__Edit_Flashcard__</a>
            <a id="edit-card-delete" data-role="button" data-theme="r" data-icon="delete">__Delete__</a>
    </div>
</div>

<div id="gallery-images" data-role="page">
    <div data-role="header" data-position="fixed">
        <h2>__Gallery__</h2>        
    </div>
    <div data-role="content">
        <p>__MSG_Gallery__</p>
        <div id="gallery-image" class="carousel-images-gallery">
            <div>
                <div id="gallery-carousel"></div>
            </div>
        </div>
    </div>
</div>

<!-- Templates -->
<div id="templates" data-role="page">	
    <li id="template-card" data-role="listitem">
            <a href="" class="card-manager-edit-button" data-rel="dialog">                
                <h3><div class="ui-icon ui-icon-question" style="float:left" title="Question"></div>&nbsp;
                    <span class="card-manager-question"></span></h3>
                <h3><div class="ui-icon ui-icon-chat" style="float:left" title="Answer"></div>&nbsp; 
                    <span class="card-manager-answer"></span></h3>
                <span class="ui-li-count" title=""></span>
            </a>
      </li>
    
    <li id="template-card-image" data-role="listitem">
            <a href="" class="card-manager-edit-button" data-rel="dialog">
                <img class="card-manager-img">
                <h3><div class="ui-icon ui-icon-question" style="float:left" title="Question"></div>&nbsp;
                    <span class="card-manager-question"></span></h3>
                <h3><div class="ui-icon ui-icon-chat" style="float:left" title="Answer"></div>&nbsp; 
                    <span class="card-manager-answer"></span></h3>
                <span class="ui-li-count" title=""></span>
            </a>
    </li>
    <img id="template-image" class="gallery-img"/>
    <li id="template-non-project" data-role="listitem">
        <h3 class="project-name"></h3>
        <p class="project-description"></p>
    </li>
</div>

<script src="js/lang.js"></script>
<script type="text/javascript">
/*projectID*/
var cardsPreview;
Cobra.install();
$(document).ready(function(e){
    $('#lang').hide();
    lang.start();
    lang.getLanguage();
   // var gallery = new Gallery('gallery-image');
    //gallery.load();
    var projectId=location.search;
    projectId=projectId.replace(/(\?project\=)/,'');
    projectId=projectId.substr(0,projectId.search('&'));
   
	var project=new Project();
	project.setId(projectId);
	project.updateManager();
	var editCard=$('#edit-card-dialog');       
    $('.prova').click(function(){
        console.log('test');
    })
	$('#edit-card-dialog').bind('pageshow', function(){ 
	   $('li').removeClass(MISSING);
	});
	$('#add-card-dialog').bind('pageshow', function(e){ 
        //gallery.fillImg(e);
       $('li').removeClass(MISSING);
    });
    //Elimina la imagen de la flashcard
    $('#edit-card-image-clear').click(function(){
        $('.flashcard-submit').click();
    });
	//Añade/Edita una flashcard  
	$('.flashcard-submit').click(function(){
		var edit=$(this).attr('id')=='edit-card-finish';
		var question=(edit)?$('#edit-card-question').val():$('#add-card-question').val();            
        var q1=$.trim(question);
        var answer=(edit)?$('#edit-card-answer').val():$('#add-card-answer').val();
        var a1=$.trim(answer);
        var imageField = (edit)?$('#edit-card-new-image'):$('#add-card-new-image');        
        if(q1!=''&&a1!=''){
            act=(edit)?action.EDIT:action.ADD;
            if(edit)
                var card=new Card(editCard.jqmData('card').id,question,answer,null);
            else
                var card=new Card(null,question,answer,null);
            console.log(card.imageURL);
            console.log(imageField.val());
            if(imageField.val()){
                 imageField.uploadImage(function(imageURL){
                      //called later
                      card.imageURL = imageURL;     
                      project.saveCard(card,act);
                      imageField.val('');
                 });
                 //TODO maybe upload each time they change the image (or just read it) so we can show a preview
            }else
                project.saveCard(card,act);
            if($('li').hasClass(MISSING))
                $('li').removeClass(MISSING);
            $.mobile.changePage('#card-manager');
            //$('div[data-role="dialog"]').dialog('close');
        }else{
            if(q1==''){
                if(!$('.question').hasClass(MISSING))
                    $('.question').addClass(MISSING);
            }else
                $('.question').removeClass(MISSING);
                
            if(a1==''){
                if(!$('.answer').hasClass(MISSING))
                    $('.answer').addClass(MISSING); 
            }else
                $('.answer').removeClass(MISSING);  
        }
	}); 
    
    
    //Elimina una flashcard
    $('#edit-card-delete').click(function(){
        var card=editCard.jqmData('card');                  
        project.saveCard(card,action.DELETE);                               
        $('#edit-card-dialog').dialog('close');
    });
    
	//Recoje los datos de un CSV
	$('#file').change(function(evt){		
		$('#card-manager-list').show();
		var files = evt.target.files; // FileList object
		
		// Loop through the FileList and render image files as thumbnails.
		for (var i = 0, f; f = files[i]; i++) {
		  var reader = new FileReader();
	
		  // Closure to capture the file information.
		  reader.onload = (function(theFile) {
			return function(e) {
				cardsPreview=e.target.result.split('\n');
				project.updateManagerFile(cardsPreview);
				$('#import-csv').each (function(){
					  this.reset();
					});						
			}
		  })(f);
		  
		  // Read in the file as text.
		  reader.readAsBinaryString(f);
		  
		} 
	});
	
	//Elimina una flashcard del importador CSV
    $('#delete').click(function(){
        cardsPreview.splice(cID,1);
        project.updateManagerFile(cardsPreview);
    });
    
    //Inicializa la página del importador CSV
    $('a[href="#card-importer"]').click(function(){
        cardsPreview=[];
        $('#add-import-csv').hide();
        $('#card-manager-list').hide(); 
    });
    
	
	
	
});

</script>
</body>
</html>